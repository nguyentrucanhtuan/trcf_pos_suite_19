<odoo>
    <template id="purchase_form_template">

        <xpath expr="//head" position="inside">
            <meta charset="utf-8"/>
            <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
            <title>Nhập hàng</title>
            <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
            <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&amp;display=swap" rel="stylesheet"/>
            <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
            
            <!-- Flatpickr Date Picker -->
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"/>
            <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
            
            <script>
                tailwind.config = {
                    darkMode: "class",
                    theme: {
                        extend: {
                            colors: {
                                primary: '#2563eb',
                                'primary-light': '#eff6ff',
                                'primary-dark': '#1e40af',
                                'background-light': '#f8fafc',
                                'background-dark': '#020617',
                                'text-light-primary': '#1e293b',
                                'text-light-secondary': '#64748b',
                                'text-dark-primary': '#f8fafc',
                                'text-dark-secondary': '#94a3b8',
                                'border-light': '#e2e8f0',
                                'border-dark': '#1e293b',
                            },
                            fontFamily: {
                                "display": ["Inter", "sans-serif"]
                            },
                            borderRadius: {
                                "DEFAULT": "0.5rem",
                                "lg": "0.75rem",
                                "xl": "1rem",
                                "full": "9999px"
                            },
                        },
                    },
                }
            </script>
            <style>
                body {
                    font-family: 'Inter', sans-serif;
                }
                .material-symbols-outlined {
                    font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
                }
                
                /* Custom Select Styles */
                .custom-select-container {
                    position: relative;
                }

                .custom-select-search {
                    transition: all 0.2s ease;
                }

                .custom-select-dropdown {
                    position: fixed;
                    max-height: 300px;
                    overflow-y: auto;
                    margin-top: 4px;
                    border-radius: 0.5rem;
                    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
                    z-index: 100;
                    opacity: 0;
                    transform: translateY(-10px);
                    transition: all 0.15s ease-out;
                    pointer-events: none;
                }

                .custom-select-dropdown.active {
                    opacity: 1;
                    transform: translateY(0) !important;
                    pointer-events: auto;
                }

                .custom-select-option {
                    padding: 0.75rem 1rem;
                    cursor: pointer;
                    transition: all 0.1s ease;
                }

                .custom-select-option:hover,
                .custom-select-option.highlighted {
                    background-color: rgb(239 246 255);
                }

                .dark .custom-select-option:hover,
                .dark .custom-select-option.highlighted {
                    background-color: rgb(30 41 59);
                }

                .custom-select-option.selected {
                    background-color: rgb(219 234 254);
                }

                .dark .custom-select-option.selected {
                    background-color: rgb(30 58 138);
                }

                .custom-select-no-results {
                    padding: 1rem;
                    text-align: center;
                    color: rgb(148 163 184);
                }

                /* Hide original select */
                .custom-select-container select {
                    display: none;
                }
                
                /* Flatpickr custom styling */
                .flatpickr-calendar {
                    font-family: 'Inter', sans-serif;
                    border-radius: 0.75rem;
                    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
                }
                .flatpickr-day.selected {
                    background: #2563eb;
                    border-color: #2563eb;
                }
                .flatpickr-day:hover {
                    background: #eff6ff;
                    border-color: #eff6ff;
                }
            </style>
        </xpath>

        <xpath expr="//body" position="replace">

            <body class="font-display bg-background-light dark:bg-background-dark">
                <div class="flex min-h-screen relative">
                    <!-- Mobile Menu Button -->
                    <button id="mobile-menu-btn" class="md:hidden fixed top-4 left-4 z-50 p-2 bg-white dark:bg-slate-800 rounded-lg shadow-lg border border-gray-200 dark:border-slate-700">
                        <span class="material-symbols-outlined text-gray-700 dark:text-gray-300">menu</span>
                    </button>
                    
                    <!-- Mobile Overlay -->
                    <div id="mobile-overlay" class="hidden fixed inset-0 bg-black/50 z-30 md:hidden"></div>
                    
                    <!-- SideNavBar -->
                    <div id="sidebar-wrapper" class="hidden md:block fixed md:relative inset-y-0 left-0 z-40 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
                        <t t-call="trcf_fnb_inventory.sidebar_layout_template"/>
                    </div>

                    <!-- Main Content -->
                    <main class="flex-1 p-4 md:p-6 lg:p-8 pt-16 md:pt-4">
                        <div class="w-full max-w-screen mx-auto">
                            
                            <!-- Error Message -->
                            <t t-if="error">
                                <div class="mb-4 md:mb-6 p-3 md:p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg md:rounded-xl">
                                    <p class="text-red-800 dark:text-red-200 text-xs md:text-sm font-medium">
                                        <span class="material-symbols-outlined inline-block align-middle mr-1 md:mr-2 text-sm md:text-base">error</span>
                                        <t t-esc="error"/>
                                    </p>
                                </div>
                            </t>
                            
                            <form id="purchaseForm" method="POST" action="/trcf_fnb_inventory/purchase_add">
                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                <input type="hidden" name="products_data" id="products_data" value="[]"/>
                                <input type="hidden" name="action" id="form_action" value="draft"/>
                                
                                <header class="mb-4 md:mb-6">
                                    <p class="text-text-light-primary dark:text-text-dark-primary text-xl md:text-2xl lg:text-4xl font-black leading-tight tracking-[-0.033em] mb-3 md:mb-4">Tạo Phiếu Nhập Hàng</p>
                                    <button type="button" onclick="submitForm('confirm')" class="flex items-center justify-center gap-x-2 h-9 md:h-10 px-3 md:px-4 rounded-lg bg-primary hover:bg-primary-dark dark:bg-primary dark:hover:bg-blue-700 text-white dark:text-white transition-colors text-xs md:text-sm font-bold">
                                        <span class="material-symbols-outlined text-sm md:text-base">save</span>
                                        <span>Tạo đơn mua hàng</span>
                                    </button>
                                </header>
                                
                                <div class="flex flex-col gap-4 md:gap-6 lg:gap-8">
                                    <!-- Thông tin đơn hàng -->
                                    <div class="bg-white dark:bg-slate-900 border border-border-light dark:border-border-dark rounded-lg md:rounded-xl p-4 md:p-6">
                                        <h2 class="text-text-light-primary dark:text-white text-base md:text-lg lg:text-xl font-bold leading-tight mb-4 md:mb-6">Thông tin đơn hàng</h2>
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-5">
                                            
                                            <!-- Ngày nhập hàng (tự động) -->
                                            <label class="flex flex-col w-full">
                                                <p class="text-text-light-secondary dark:text-text-dark-secondary text-xs md:text-sm font-medium leading-normal pb-1 md:pb-2">Ngày nhập hàng</p>
                                                <div class="relative">
                                                    <span class="material-symbols-outlined absolute left-3 md:left-4 top-1/2 -translate-y-1/2 text-text-light-secondary dark:text-text-dark-secondary text-lg md:text-xl">calendar_today</span>
                                                    <input readonly="readonly" class="form-input pl-10 md:pl-12 flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-text-light-primary dark:text-white border border-border-light dark:border-border-dark bg-slate-100 dark:bg-slate-800 h-10 md:h-12 p-[10px] md:p-[15px] text-xs md:text-sm font-normal leading-normal cursor-not-allowed" type="text" t-att-value="today" title="Ngày nhập hàng được tự động lấy từ thời gian tạo đơn"/>
                                                </div>
                                            </label>
                                            
                                            <!-- Mã tham chiếu -->
                                            <label class="flex flex-col w-full">
                                                <p class="text-text-light-secondary dark:text-text-dark-secondary text-xs md:text-sm font-medium leading-normal pb-1 md:pb-2">Mã tham chiếu</p>
                                                <input name="reference" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-text-light-primary dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-border-light dark:border-border-dark bg-white dark:bg-slate-900 focus:border-primary dark:focus:border-primary h-10 md:h-12 placeholder:text-text-light-secondary dark:placeholder:text-text-dark-secondary p-[10px] md:p-[15px] text-xs md:text-sm font-normal leading-normal" placeholder="Mã phiếu tự sinh hoặc tự nhập" t-att-value="reference or ''"/>
                                            </label>
                                            
                                            <!-- Phiếu nhập kho -->
                                            <label class="flex flex-col w-full">
                                                <p class="text-text-light-secondary dark:text-text-dark-secondary text-xs md:text-sm font-medium leading-normal pb-1 md:pb-2">
                                                    Chọn kho <span class="text-red-500">*</span>
                                                </p>
                                                <!-- Nếu cho phép nhân viên chọn: hiển thị dropdown -->
                                                <t t-if="allow_employee_select">
                                                    <select name="picking_type_id" required="required" class="form-select flex w-full min-w-0 flex-1 overflow-hidden rounded-lg text-text-light-primary dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-border-light dark:border-border-dark bg-white dark:bg-slate-900 focus:border-primary dark:focus:border-primary h-10 md:h-12 px-3 text-xs md:text-sm font-normal leading-normal">
                                                        <option value="">-- Chọn kho --</option>
                                                        <t t-foreach="picking_types" t-as="pt">
                                                            <option t-att-value="pt.id" t-att-selected="pt.id == default_picking_type_id">
                                                                <t t-esc="pt.warehouse_id.name if pt.warehouse_id else 'N/A'"/>: <t t-esc="pt.name"/>
                                                            </option>
                                                        </t>
                                                    </select>
                                                </t>
                                                <!-- Nếu không cho phép: hiển thị giá trị mặc định (readonly) + hidden input -->
                                                <t t-else="">
                                                    <input type="hidden" name="picking_type_id" t-att-value="default_picking_type_id"/>
                                                    <input readonly="readonly" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-text-light-primary dark:text-white border border-border-light dark:border-border-dark bg-slate-100 dark:bg-slate-800 h-10 md:h-12 p-[10px] md:p-[15px] text-xs md:text-sm font-normal leading-normal cursor-not-allowed" type="text" t-att-value="default_picking_type_name or 'Chưa cấu hình'" title="Kho mặc định do admin cấu hình"/>
                                                </t>
                                            </label>
                                            
                                        </div>
                                    </div>
                                    
                                    <!-- Thông tin thanh toán -->
                                    <div class="bg-white dark:bg-slate-900 border border-border-light dark:border-border-dark rounded-lg md:rounded-xl p-4 md:p-6">
                                        <h2 class="text-text-light-primary dark:text-white text-base md:text-lg lg:text-xl font-bold leading-tight mb-4 md:mb-6">Thông tin thanh toán</h2>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-5">
                                            
                                            <!-- Nhà cung cấp -->
                                            <label class="flex flex-col w-full md:col-span-2">
                                                <p class="text-text-light-secondary dark:text-text-dark-secondary text-xs md:text-sm font-medium leading-normal pb-1 md:pb-2">
                                                    Nhà cung cấp <span class="text-red-500">*</span>
                                                </p>
                                                <select name="partner_id" required="required" class="form-select flex w-full min-w-0 flex-1 overflow-hidden rounded-lg text-text-light-primary dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-border-light dark:border-border-dark bg-white dark:bg-slate-900 focus:border-primary dark:focus:border-primary h-10 md:h-12 px-3 text-xs md:text-sm font-normal leading-normal">
                                                    <option value="">-- Chọn nhà cung cấp --</option>
                                                    <t t-foreach="suppliers" t-as="supplier">
                                                        <option t-att-value="supplier.id" t-esc="supplier.name"/>
                                                    </t>
                                                </select>
                                            </label>
                                            
                                            <!-- Trạng thái thanh toán -->
                                            <div class="flex flex-col w-full">
                                                <p class="text-text-light-secondary dark:text-text-dark-secondary text-xs md:text-sm font-medium leading-normal pb-1 md:pb-2">Trạng thái thanh toán</p>
                                                <div class="flex items-center gap-4 md:gap-6 h-10 md:h-12">
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input class="form-radio text-primary focus:ring-primary/50 w-4 h-4" name="payment_status" type="radio" value="paid"/>
                                                        <span class="text-text-light-primary dark:text-white text-xs md:text-sm">Đã thanh toán</span>
                                                    </label>
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input checked="checked" class="form-radio text-primary focus:ring-primary/50 w-4 h-4" name="payment_status" type="radio" value="unpaid"/>
                                                        <span class="text-text-light-primary dark:text-white text-xs md:text-sm">Chưa TT</span>
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <!-- Phương thức thanh toán -->
                                            <label class="flex flex-col w-full">
                                                <p class="text-text-light-secondary dark:text-text-dark-secondary text-xs md:text-sm font-medium leading-normal pb-1 md:pb-2">Phương thức TT</p>
                                                <select name="payment_method_id" class="form-select flex w-full min-w-0 flex-1 overflow-hidden rounded-lg text-text-light-primary dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-border-light dark:border-border-dark bg-white dark:bg-slate-900 focus:border-primary dark:focus:border-primary h-10 md:h-12 px-3 text-xs md:text-sm font-normal leading-normal">
                                                    <option value="">-- Chọn --</option>
                                                    <t t-foreach="payment_methods" t-as="pm">
                                                        <option t-att-value="pm.get('id')" t-esc="pm.get('name')"/>
                                                    </t>
                                                </select>
                                            </label>
                                            
                                            <!-- Ngày thanh toán -->
                                            <label class="flex flex-col w-full md:col-span-2">
                                                <p class="text-text-light-secondary dark:text-text-dark-secondary text-xs md:text-sm font-medium leading-normal pb-1 md:pb-2">Ngày thanh toán</p>
                                                <div class="relative">
                                                    <span class="material-symbols-outlined absolute left-3 md:left-4 top-1/2 -translate-y-1/2 text-text-light-secondary dark:text-text-dark-secondary pointer-events-none text-lg md:text-xl">calendar_today</span>
                                                    <input id="payment_date_input" name="payment_date" class="form-input pl-10 md:pl-12 flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-text-light-primary dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-border-light dark:border-border-dark bg-white dark:bg-slate-900 focus:border-primary dark:focus:border-primary h-10 md:h-12 p-[10px] md:p-[15px] text-xs md:text-sm font-normal leading-normal cursor-pointer" placeholder="DD/MM/YYYY HH:MM:SS" type="text" readonly="readonly"/>
                                                </div>
                                            </label>
                                            
                                            <!-- Ghi chú đơn hàng -->
                                            <label class="flex flex-col w-full md:col-span-2">
                                                <p class="text-text-light-secondary dark:text-text-dark-secondary text-xs md:text-sm font-medium leading-normal pb-1 md:pb-2">Ghi chú</p>
                                                <input name="notes" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-text-light-primary dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-border-light dark:border-border-dark bg-white dark:bg-slate-900 focus:border-primary dark:focus:border-primary h-10 md:h-12 placeholder:text-text-light-secondary dark:placeholder:text-text-dark-secondary p-[10px] md:p-[15px] text-xs md:text-sm font-normal leading-normal" placeholder="Thêm ghi chú..."/>
                                            </label>
                                            
                                        </div>
                                    </div>
                                    
                                    <!-- Chi tiết sản phẩm -->
                                    <div class="bg-white dark:bg-slate-900 border border-border-light dark:border-border-dark rounded-lg md:rounded-xl p-4 md:p-6">
                                        <h2 class="text-text-light-primary dark:text-white text-base md:text-lg lg:text-xl font-bold leading-tight mb-4 md:mb-6">Chi tiết Sản phẩm</h2>
                                        <div class="flow-root">
                                            <div class="-mx-4 md:-mx-6 -my-2 overflow-x-auto">
                                                <div class="inline-block min-w-full py-2 align-middle px-4 md:px-6">
                                                    <div class="overflow-hidden">
                                                        <table class="min-w-full" id="productsTable">
                                                            <thead class="border-b border-border-light dark:border-border-dark">
                                                                <tr>
                                                                    <th class="py-2 md:py-3.5 pl-2 md:pl-4 pr-2 md:pr-3 text-left text-xs md:text-sm font-semibold text-text-light-secondary dark:text-text-dark-secondary w-[30%]" scope="col">Sản phẩm</th>
                                                                    <th class="px-2 md:px-3 py-2 md:py-3.5 text-left text-xs md:text-sm font-semibold text-text-light-secondary dark:text-text-dark-secondary w-[15%] hidden sm:table-cell" scope="col">ĐVT</th>
                                                                    <th class="px-2 md:px-3 py-2 md:py-3.5 text-left text-xs md:text-sm font-semibold text-text-light-secondary dark:text-text-dark-secondary w-[15%]" scope="col">SL</th>
                                                                    <th class="px-2 md:px-3 py-2 md:py-3.5 text-left text-xs md:text-sm font-semibold text-text-light-secondary dark:text-text-dark-secondary w-[20%]" scope="col">Giá</th>
                                                                    <th class="px-2 md:px-3 py-2 md:py-3.5 text-left text-xs md:text-sm font-semibold text-text-light-secondary dark:text-text-dark-secondary w-[10%] hidden md:table-cell" scope="col">VAT</th>
                                                                    <th class="relative py-2 md:py-3.5 pl-2 md:pl-3 pr-2 md:pr-4" scope="col">
                                                                        <span class="sr-only">Xóa</span>
                                                                    </th>
                                                                </tr>
                                                            </thead>
                                                            <tbody class="text-text-light-primary dark:text-white" id="productLines">
                                                                <!-- Product lines will be added here by JavaScript -->
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-4 md:mt-6 flex flex-col md:flex-row items-start gap-4 md:gap-6">
                                            <div class="w-full md:w-auto flex-grow">
                                                <button type="button" onclick="addProductLine()" class="flex items-center justify-center gap-2 w-full px-4 md:px-5 py-2 md:py-3 rounded-lg bg-primary/10 dark:bg-primary/20 text-primary dark:text-primary text-xs md:text-sm font-bold leading-normal hover:bg-primary/20 dark:hover:bg-primary/30 transition-colors">
                                                    <span class="material-symbols-outlined text-lg md:text-xl">add_circle</span> Thêm sản phẩm
                                                </button>
                                            </div>
                                            <div class="w-full md:w-2/5 lg:w-1/3">
                                                <div class="space-y-2 md:space-y-3 text-text-light-secondary dark:text-text-dark-secondary text-xs md:text-sm">
                                                    <div class="flex justify-between items-center">
                                                        <p>Trước thuế</p>
                                                        <p class="font-medium text-text-light-primary dark:text-white" id="subtotal">0đ</p>
                                                    </div>
                                                    <div id="vatBreakdown">
                                                        <!-- VAT breakdown will be added here -->
                                                    </div>
                                                    <div class="border-t border-border-light dark:border-border-dark my-2 md:my-3"></div>
                                                    <div class="flex justify-between items-center text-sm md:text-base">
                                                        <p class="font-bold text-text-light-primary dark:text-white">Tổng cộng</p>
                                                        <p class="font-bold text-primary dark:text-primary" id="total">0đ</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </main>
                </div>
                
                <!-- Mobile Menu JavaScript -->
                <script>
                <![CDATA[
                    document.addEventListener('DOMContentLoaded', function() {
                        const menuBtn = document.getElementById('mobile-menu-btn');
                        const sidebar = document.getElementById('sidebar-wrapper');
                        const overlay = document.getElementById('mobile-overlay');
                        
                        if (menuBtn && sidebar && overlay) {
                            menuBtn.addEventListener('click', function() {
                                sidebar.classList.toggle('hidden');
                                sidebar.classList.toggle('translate-x-0');
                                overlay.classList.toggle('hidden');
                            });
                            
                            overlay.addEventListener('click', function() {
                                sidebar.classList.add('hidden');
                                sidebar.classList.remove('translate-x-0');
                                overlay.classList.add('hidden');
                            });
                        }
                    });
                ]]>
                </script>
                
                <!-- JavaScript -->
                <script>
                <![CDATA[
                    // Data from backend - these will be populated by Odoo template engine before CDATA
                    let productsData = [];
                    
                    // This function will be called after data is loaded
                    function initializeData(products) {
                        productsData = products;
                    }
                    
                    let lineCounter = 0;
                    let paymentDatePicker = null;
                    
                    // Helper: Remove Vietnamese accents for better search
                    function removeVietnameseAccents(str) {
                        return str.normalize('NFD')
                            .replace(/[\u0300-\u036f]/g, '')
                            .replace(/đ/g, 'd').replace(/Đ/g, 'D')
                            .toLowerCase();
                    }
                    
                    // Helper: Escape HTML
                    function escapeHtml(text) {
                        const map = {
                            '&': '&amp;',
                            '<': '&lt;',
                            '>': '&gt;',
                            '"': '&quot;',
                            "'": '&#039;'
                        };
                        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
                    }
                    
                    // Helper: Debounce function
                    function debounce(func, wait) {
                        let timeout;
                        return function executedFunction(...args) {
                            const later = () => {
                                clearTimeout(timeout);
                                func(...args);
                            };
                            clearTimeout(timeout);
                            timeout = setTimeout(later, wait);
                        };
                    }
                    
                    // Initialize product search for a specific line
                    function initializeProductSearch(lineId) {
                        const searchInput = document.getElementById('product_search_' + lineId);
                        const dropdown = document.getElementById('product_dropdown_' + lineId);
                        const select = document.getElementById('product_select_' + lineId);
                        const clearBtn = document.getElementById('clear_search_' + lineId);
                        const container = document.getElementById('product_container_' + lineId);
                        
                        let filteredProducts = [];
                        let selectedIndex = -1;
                        let isDropdownOpen = false;
                        
                        // Filter and render products
                        const filterProducts = debounce(function(searchTerm) {
                            if (!searchTerm) {
                                filteredProducts = [...productsData];
                            } else {
                                const searchText = removeVietnameseAccents(searchTerm);
                                filteredProducts = productsData.filter(p =>
                                    removeVietnameseAccents(p.name).includes(searchText)
                                );
                            }
                            selectedIndex = filteredProducts.length > 0 ? 0 : -1;
                            renderDropdown();
                        }, 300);
                        
                        // Render dropdown options
                        function renderDropdown() {
                            if (filteredProducts.length === 0) {
                                dropdown.innerHTML = '<div class="custom-select-no-results">Không tìm thấy sản phẩm</div>';
                                return;
                            }
                            
                            dropdown.innerHTML = filteredProducts.map((product, index) => {
                                const isSelected = index === selectedIndex;
                                return `
                                    <div class="custom-select-option ${isSelected ? 'highlighted' : ''}"
                                         data-index="${index}"
                                         data-value="${product.id}">
                                        <div class="font-medium text-text-light-primary dark:text-text-dark-primary">
                                            ${escapeHtml(product.name)}
                                        </div>
                                    </div>
                                `;
                            }).join('');
                            
                            // Add click listeners
                            dropdown.querySelectorAll('.custom-select-option').forEach(option => {
                                option.addEventListener('click', function() {
                                    const index = parseInt(this.getAttribute('data-index'));
                                    selectProduct(index);
                                });
                            });
                        }
                        
                        // Open dropdown
                        function openDropdown() {
                            if (!isDropdownOpen) {
                                isDropdownOpen = true;
                                
                                // Calculate position for fixed dropdown
                                const rect = searchInput.getBoundingClientRect();
                                const dropdownMaxHeight = 300;
                                const spaceBelow = window.innerHeight - rect.bottom;
                                const spaceAbove = rect.top;
                                
                                // Decide whether to show dropdown above or below input
                                if (spaceBelow < dropdownMaxHeight && spaceAbove > spaceBelow) {
                                    // Show above input
                                    dropdown.style.bottom = (window.innerHeight - rect.top + 4) + 'px';
                                    dropdown.style.top = 'auto';
                                    dropdown.style.transform = 'translateY(10px)';
                                } else {
                                    // Show below input (default)
                                    dropdown.style.top = (rect.bottom + 4) + 'px';
                                    dropdown.style.bottom = 'auto';
                                    dropdown.style.transform = 'translateY(-10px)';
                                }
                                
                                dropdown.style.left = rect.left + 'px';
                                dropdown.style.width = rect.width + 'px';
                                
                                dropdown.classList.add('active');
                                filterProducts(searchInput.value);
                            }
                        }
                        
                        // Close dropdown
                        function closeDropdown() {
                            if (isDropdownOpen) {
                                isDropdownOpen = false;
                                dropdown.classList.remove('active');
                            }
                        }
                        
                        // Select product
                        function selectProduct(index) {
                            if (index < 0 || index >= filteredProducts.length) return;
                            
                            const product = filteredProducts[index];
                            select.value = product.id;
                            searchInput.value = product.name;
                            closeDropdown();
                            updateProductUOM(lineId);
                            clearBtn.style.display = 'block';
                        }
                        
                        // Clear search
                        function clearSearch() {
                            searchInput.value = '';
                            select.value = '';
                            clearBtn.style.display = 'none';
                            closeDropdown();
                            updateProductUOM(lineId);
                        }
                        
                        // Keyboard navigation
                        function handleKeyDown(e) {
                            if (!isDropdownOpen) {
                                if (e.key === 'ArrowDown' || e.key === 'Enter') {
                                    openDropdown();
                                    e.preventDefault();
                                }
                                return;
                            }
                            
                            switch(e.key) {
                                case 'ArrowDown':
                                    e.preventDefault();
                                    selectedIndex = Math.min(selectedIndex + 1, filteredProducts.length - 1);
                                    renderDropdown();
                                    break;
                                case 'ArrowUp':
                                    e.preventDefault();
                                    selectedIndex = Math.max(selectedIndex - 1, 0);
                                    renderDropdown();
                                    break;
                                case 'Enter':
                                    e.preventDefault();
                                    if (selectedIndex >= 0) {
                                        selectProduct(selectedIndex);
                                    }
                                    break;
                                case 'Escape':
                                    e.preventDefault();
                                    closeDropdown();
                                    break;
                            }
                        }
                        
                        // Event listeners
                        searchInput.addEventListener('input', function(e) {
                            filterProducts(e.target.value);
                            openDropdown();
                            clearBtn.style.display = e.target.value ? 'block' : 'none';
                        });
                        
                        searchInput.addEventListener('focus', openDropdown);
                        searchInput.addEventListener('keydown', handleKeyDown);
                        clearBtn.addEventListener('click', clearSearch);
                        
                        // Close dropdown when clicking outside
                        document.addEventListener('click', function(e) {
                            if (!container.contains(e.target)) {
                                closeDropdown();
                            }
                        });
                    }
                    
                    
                    // Initialize date picker and add initial product line
                    document.addEventListener('DOMContentLoaded', function() {
                        // Initialize Flatpickr for payment date with time (date + time)
                        const now = new Date();
                        paymentDatePicker = flatpickr("#payment_date_input", {
                            dateFormat: "d/m/Y H:i:S",
                            enableTime: true,
                            enableSeconds: true,
                            time_24hr: true,
                            allowInput: true,
                            defaultDate: now,
                            locale: {
                                firstDayOfWeek: 1,
                                weekdays: {
                                    shorthand: ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'],
                                    longhand: ['Chủ nhật', 'Thứ hai', 'Thứ ba', 'Thứ tư', 'Thứ năm', 'Thứ sáu', 'Thứ bảy']
                                },
                                months: {
                                    shorthand: ['Th1', 'Th2', 'Th3', 'Th4', 'Th5', 'Th6', 'Th7', 'Th8', 'Th9', 'Th10', 'Th11', 'Th12'],
                                    longhand: ['Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6', 'Tháng 7', 'Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11', 'Tháng 12']
                                }
                            }
                        });
                        
                        // Add event listeners for payment status radio buttons
                        const paymentStatusRadios = document.querySelectorAll('input[name="payment_status"]');
                        paymentStatusRadios.forEach(function(radio) {
                            radio.addEventListener('change', handlePaymentStatusChange);
                        });
                        
                        // Set initial state (unpaid is default)
                        handlePaymentStatusChange();
                        
                        addProductLine();
                    });
                    
                    function handlePaymentStatusChange() {
                        const paymentStatus = document.querySelector('input[name="payment_status"]:checked').value;
                        const paymentMethodSelect = document.querySelector('select[name="payment_method_id"]');
                        const paymentDateInput = document.getElementById('payment_date_input');
                        
                        if (paymentStatus === 'unpaid') {
                            // Disable payment method and payment date
                            paymentMethodSelect.disabled = true;
                            paymentMethodSelect.classList.add('bg-slate-100', 'dark:bg-slate-800', 'cursor-not-allowed', 'opacity-60');
                            paymentMethodSelect.classList.remove('bg-white', 'dark:bg-slate-900');
                            
                            paymentDateInput.disabled = true;
                            paymentDateInput.classList.add('bg-slate-100', 'dark:bg-slate-800', 'cursor-not-allowed', 'opacity-60');
                            paymentDateInput.classList.remove('bg-white', 'dark:bg-slate-900', 'cursor-pointer');
                            
                            // Clear values
                            paymentMethodSelect.value = '';
                            if (paymentDatePicker) {
                                paymentDatePicker.clear();
                            }
                        } else {
                            // Enable payment method and payment date
                            paymentMethodSelect.disabled = false;
                            paymentMethodSelect.classList.remove('bg-slate-100', 'dark:bg-slate-800', 'cursor-not-allowed', 'opacity-60');
                            paymentMethodSelect.classList.add('bg-white', 'dark:bg-slate-900');
                            
                            paymentDateInput.disabled = false;
                            paymentDateInput.classList.remove('bg-slate-100', 'dark:bg-slate-800', 'cursor-not-allowed', 'opacity-60');
                            paymentDateInput.classList.add('bg-white', 'dark:bg-slate-900', 'cursor-pointer');
                            
                            // Set payment date to current date/time
                            if (paymentDatePicker && !paymentDateInput.value) {
                                paymentDatePicker.setDate(new Date());
                            }
                        }
                    }
                    
                    function addProductLine() {
                        const tbody = document.getElementById('productLines');
                        const lineId = lineCounter++;
                        
                        const tr = document.createElement('tr');
                        tr.className = 'border-b border-border-light dark:border-border-dark';
                        tr.id = 'line_' + lineId;
                        
                        // Build product options for hidden select
                        let productOptions = '<option value="">-- Chọn sản phẩm --</option>';
                        productsData.forEach(function(p) {
                            productOptions += '<option value="' + p.id + '" data-name="' + escapeHtml(p.name) + '">' + escapeHtml(p.name) + '</option>';
                        });
                        
                        tr.innerHTML = 
                            '<td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium sm:pl-0">' +
                                '<div class="custom-select-container" id="product_container_' + lineId + '">' +
                                    '<div class="relative">' +
                                        '<input type="text" id="product_search_' + lineId + '" ' +
                                            'placeholder="Tìm kiếm sản phẩm..." ' +
                                            'autocomplete="off" ' +
                                            'class="custom-select-search form-input w-full rounded-lg text-text-light-primary dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-border-light dark:border-border-dark bg-white dark:bg-slate-900 focus:border-primary dark:focus:border-primary text-sm px-3 py-2"/>' +
                                        '<span id="clear_search_' + lineId + '" class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-text-light-secondary dark:text-text-dark-secondary cursor-pointer hover:text-text-light-primary dark:hover:text-text-dark-primary text-base" style="display: none;">close</span>' +
                                    '</div>' +
                                    '<div id="product_dropdown_' + lineId + '" class="custom-select-dropdown bg-white dark:bg-slate-900 border border-border-light dark:border-border-dark"></div>' +
                                    '<select onchange="updateProductUOM(' + lineId + ')" id="product_select_' + lineId + '" class="product-select form-select">' +
                                        productOptions +
                                    '</select>' +
                                '</div>' +
                            '</td>' +
                            '<td class="whitespace-nowrap px-3 py-4 text-sm">' +
                                '<select onchange="updatePriceOnUOMChange(' + lineId + ')" class="uom-select form-select w-full rounded-lg text-text-light-primary dark:text-white focus:outline-none focus:ring-2 focus:ring-primary/50 border-border-light dark:border-border-dark bg-white dark:bg-slate-900 focus:border-primary dark:focus:border-primary text-sm">' +
                                    '<option value="">-- Chọn đơn vị --</option>' +
                                '</select>' +
                            '</td>' +
                            '<td class="whitespace-nowrap px-3 py-4 text-sm">' +
                                '<input onchange="calculateTotals()" class="qty-input form-input w-full rounded-lg text-text-light-primary dark:text-white focus:outline-none focus:ring-2 focus:ring-primary/50 border-border-light dark:border-border-dark bg-white dark:bg-slate-900 focus:border-primary dark:focus:border-primary text-sm" type="number" min="0" step="0.01" value="1"/>' +
                            '</td>' +
                            '<td class="whitespace-nowrap px-3 py-4 text-sm">' +
                                '<input onchange="calculateTotals()" class="price-input form-input w-full rounded-lg text-text-light-primary dark:text-white focus:outline-none focus:ring-2 focus:ring-primary/50 border-border-light dark:border-border-dark bg-white dark:bg-slate-900 focus:border-primary dark:focus:border-primary text-sm" type="number" min="0" step="1000" value="0"/>' +
                            '</td>' +
                            '<td class="whitespace-nowrap px-3 py-4 text-sm">' +
                                '<select onchange="calculateTotals()" class="vat-select form-select w-full rounded-lg text-text-light-primary dark:text-white focus:outline-none focus:ring-2 focus:ring-primary/50 border-border-light dark:border-border-dark bg-white dark:bg-slate-900 focus:border-primary dark:focus:border-primary text-sm">' +
                                    '<option value="0" data-amount="0">-- Chọn sản phẩm trước --</option>' +
                                '</select>' +
                            '</td>' +
                            '<td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-0">' +
                                '<button type="button" onclick="removeProductLine(' + lineId + ')" class="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 transition-colors">' +
                                    '<span class="material-symbols-outlined">delete</span>' +
                                '</button>' +
                            '</td>';
                        
                        tbody.appendChild(tr);
                        
                        // Initialize search for this line
                        initializeProductSearch(lineId);
                        
                        calculateTotals();
                    }
                    
                    function updateProductUOM(lineId) {
                        const line = document.getElementById('line_' + lineId);
                        const productSelect = line.querySelector('.product-select');
                        const uomSelect = line.querySelector('.uom-select');
                        const priceInput = line.querySelector('.price-input');
                        const vatSelect = line.querySelector('.vat-select');
                        
                        const productId = parseInt(productSelect.value);
                        
                        if (!productId) {
                            // Clear UOM select if no product selected
                            uomSelect.innerHTML = '<option value="">-- Chọn đơn vị --</option>';
                            priceInput.value = 0;
                            vatSelect.value = '0';
                            return;
                        }
                        
                        // Find product data
                        const product = productsData.find(p => p.id === productId);
                        
                        if (!product) {
                            return;
                        }
                        
                        // Build UOM options: primary UOM + secondary UOMs
                        let uomOptions = '';
                        
                        // Add primary UOM first (as default)
                        if (product.uom_id) {
                            uomOptions += '<option value="' + product.uom_id.id + '" data-factor="' + product.uom_id.factor + '" selected>' + product.uom_id.name + '</option>';
                        }
                        
                        // Add secondary UOMs
                        if (product.uom_ids && product.uom_ids.length > 0) {
                            product.uom_ids.forEach(function(uom) {
                                // Don't duplicate the primary UOM
                                if (!product.uom_id || uom.id !== product.uom_id.id) {
                                    uomOptions += '<option value="' + uom.id + '" data-factor="' + uom.factor + '">' + uom.name + '</option>';
                                }
                            });
                        }
                        
                        uomSelect.innerHTML = uomOptions;
                        
                        // Set price from standard_price (base price in primary UOM)
                        priceInput.value = Math.round(product.standard_price);
                        
                        // Build VAT dropdown from product's supplier_taxes
                        let vatOptions = '<option value="0" data-amount="0">Không thuế (0%)</option>';
                        
                        if (product.supplier_taxes && product.supplier_taxes.length > 0) {
                            // Add taxes from product's supplier_taxes_id
                            product.supplier_taxes.forEach(function(tax) {
                                vatOptions += '<option value="' + tax.id + '" data-amount="' + tax.amount + '">' + tax.name + ' (' + tax.amount + '%)</option>';
                            });
                            
                            // Update dropdown with product's taxes
                            vatSelect.innerHTML = vatOptions;
                            
                            // Auto-select first tax
                            vatSelect.value = product.supplier_taxes[0].id;
                        } else {
                            // No taxes configured for this product
                            vatSelect.innerHTML = vatOptions;
                            vatSelect.value = '0';
                        }
                        
                        // Store product data on the line for later use
                        line.setAttribute('data-product-id', productId);
                        line.setAttribute('data-base-price', product.standard_price);
                        
                        // Recalculate totals
                        calculateTotals();
                    }
                    
                    function updatePriceOnUOMChange(lineId) {
                        const line = document.getElementById('line_' + lineId);
                        const uomSelect = line.querySelector('.uom-select');
                        const priceInput = line.querySelector('.price-input');
                        
                        const basePrice = parseFloat(line.getAttribute('data-base-price')) || 0;
                        const selectedOption = uomSelect.options[uomSelect.selectedIndex];
                        const factor = parseFloat(selectedOption.getAttribute('data-factor')) || 1.0;
                        
                        // Convert price based on UOM factor
                        // If factor > 1, it means this UOM is bigger (e.g., 1 thùng = 12 chai)
                        // So price should be multiplied by factor
                        const convertedPrice = basePrice * factor;
                        priceInput.value = Math.round(convertedPrice);
                        
                        calculateTotals();
                    }
                    
                    function removeProductLine(lineId) {
                        const line = document.getElementById('line_' + lineId);
                        if (line) {
                            line.remove();
                            calculateTotals();
                        }
                    }
                    
                    function calculateTotals() {
                        const lines = document.querySelectorAll('#productLines tr');
                        let subtotal = 0;
                        const vatGroups = {};
                        
                        lines.forEach(function(line) {
                            const qty = parseFloat(line.querySelector('.qty-input').value) || 0;
                            const price = parseFloat(line.querySelector('.price-input').value) || 0;
                            
                            // Get VAT from select dropdown
                            const vatSelect = line.querySelector('.vat-select');
                            const selectedOption = vatSelect.options[vatSelect.selectedIndex];
                            const vatPercent = parseFloat(selectedOption.getAttribute('data-amount')) || 0;
                            
                            const lineSubtotal = qty * price;
                            const lineVat = lineSubtotal * (vatPercent / 100);
                            
                            subtotal += lineSubtotal;
                            
                            if (vatPercent > 0) {
                                if (!vatGroups[vatPercent]) {
                                    vatGroups[vatPercent] = 0;
                                }
                                vatGroups[vatPercent] += lineVat;
                            }
                        });
                        
                        // Update subtotal
                        document.getElementById('subtotal').textContent = formatCurrency(subtotal);
                        
                        // Update VAT breakdown
                        const vatBreakdown = document.getElementById('vatBreakdown');
                        vatBreakdown.innerHTML = '';
                        let totalVat = 0;
                        
                        Object.keys(vatGroups).sort().forEach(function(percent) {
                            const amount = vatGroups[percent];
                            totalVat += amount;
                            
                            const div = document.createElement('div');
                            div.className = 'flex justify-between items-center';
                            div.innerHTML = 
                                '<p>VAT (' + percent + '%)</p>' +
                                '<p class="font-medium text-text-light-primary dark:text-white">' + formatCurrency(amount) + '</p>';
                            vatBreakdown.appendChild(div);
                        });
                        
                        // Update total
                        const total = subtotal + totalVat;
                        document.getElementById('total').textContent = formatCurrency(total);
                    }
                    
                    function formatCurrency(amount) {
                        return new Intl.NumberFormat('vi-VN', {
                            style: 'currency',
                            currency: 'VND'
                        }).format(amount);
                    }
                    
                    function submitForm(action) {
                        // Validate
                        const partnerSelect = document.querySelector('select[name="partner_id"]');
                        if (!partnerSelect.value) {
                            alert('Vui lòng chọn nhà cung cấp');
                            return;
                        }
                        
                        const pickingTypeSelect = document.querySelector('select[name="picking_type_id"]');
                        if (!pickingTypeSelect.value) {
                            alert('Vui lòng chọn phiếu nhập kho');
                            return;
                        }
                        
                        const lines = document.querySelectorAll('#productLines tr');
                        console.log('Number of product lines:', lines.length);
                        
                        if (lines.length === 0) {
                            alert('Vui lòng thêm ít nhất một sản phẩm');
                            return;
                        }
                        
                        // Collect product data
                        const productsData = [];
                        let hasValidProduct = false;
                        
                        lines.forEach(function(line) {
                            const productId = line.querySelector('.product-select').value;
                            const uomId = line.querySelector('.uom-select').value;
                            const qty = parseFloat(line.querySelector('.qty-input').value) || 0;
                            const price = parseFloat(line.querySelector('.price-input').value) || 0;
                            
                            // Get tax ID from select dropdown
                            const vatSelect = line.querySelector('.vat-select');
                            const taxId = parseInt(vatSelect.value) || 0;
                            
                            console.log('Processing line:', {productId, uomId, qty, price, taxId});
                            
                            if (productId && qty > 0) {
                                hasValidProduct = true;
                                productsData.push({
                                    product_id: productId,
                                    uom_id: uomId,
                                    qty: qty,
                                    price_unit: price,
                                    tax_id: taxId
                                });
                            }
                        });
                        
                        console.log('Products data collected:', productsData);
                        console.log('Has valid product:', hasValidProduct);
                        
                        if (!hasValidProduct) {
                            alert('Vui lòng chọn sản phẩm và nhập số lượng hợp lệ');
                            return;
                        }
                        
                        // Set products data and action
                        const jsonData = JSON.stringify(productsData);
                        console.log('JSON data to submit:', jsonData);
                        document.getElementById('products_data').value = jsonData;
                        document.getElementById('form_action').value = action;
                        
                        // Submit form
                        document.getElementById('purchaseForm').submit();
                    }
                ]]>
                </script>
                <script>
                    // Initialize data from backend (outside CDATA to allow Odoo template processing)
                    initializeData(
                        <t t-esc="json.dumps([{
                            'id': p.id, 
                            'name': p.name, 
                            'standard_price': p.standard_price,
                            'supplier_taxes': [{'id': t.id, 'name': t.name, 'amount': t.amount} for t in p.supplier_taxes_id],
                            'uom_id': {'id': p.uom_id.id, 'name': p.uom_id.name, 'factor': 1.0},
                            'uom_ids': [{'id': u.id, 'name': u.name, 'factor': u.factor / p.uom_id.factor if p.uom_id.factor != 0 else 1.0} for u in p.uom_ids]
                        } for p in products])"/>
                    );
                </script>
            </body>
            
        </xpath>

    </template>
</odoo>