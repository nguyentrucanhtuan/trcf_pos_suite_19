<odoo>
    <template id="scrap_form_template">

        <xpath expr="//head" position="inside">
            <meta charset="utf-8"/>
            <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
            <meta name="csrf-token" t-att-content="request.csrf_token()"/>
            <title>Hủy Sản Phẩm</title>
            <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
            <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&amp;display=swap" rel="stylesheet"/>
            <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
            <script>
                tailwind.config = {
                    darkMode: "class",
                    theme: {
                        extend: {
                            colors: {
                                primary: '#2563eb',
                                'primary-light': '#eff6ff',
                                'primary-dark': '#1e40af',
                                'background-light': '#f8fafc',
                                'background-dark': '#020617',
                                'text-light-primary': '#1e293b',
                                'text-light-secondary': '#64748b',
                                'text-dark-primary': '#f8fafc',
                                'text-dark-secondary': '#94a3b8',
                                'border-light': '#e2e8f0',
                                'border-dark': '#1e293b',
                                danger: '#dc2626',
                            },
                            fontFamily: {
                                "display": ["Inter", "sans-serif"]
                            },
                            borderRadius: {
                                "DEFAULT": "0.5rem",
                                "lg": "0.75rem",
                                "xl": "1rem",
                                "full": "9999px"
                            },
                        },
                    },
                }
            </script>
            <style>
                body {
                    font-family: 'Inter', sans-serif;
                }
                .material-symbols-outlined {
                    font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
                }
            </style>
        </xpath>

        <xpath expr="//body" position="replace">

            <body class="font-display bg-background-light dark:bg-background-dark">
                <div class="flex min-h-screen">
                    <!-- SideNavBar -->
                    <t t-call="trcf_fnb_inventory.sidebar_layout_template"/>

                    <!-- Main Content -->
                    <main class="flex-1 p-8">
                        <div class="w-full max-w-2xl mx-auto">
                            
                            <!-- Error Message -->
                            <t t-if="error">
                                <div class="mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl">
                                    <p class="text-red-800 dark:text-red-200 text-sm font-medium">
                                        <span class="material-symbols-outlined inline-block align-middle mr-2">error</span>
                                        <t t-esc="error"/>
                                    </p>
                                </div>
                            </t>
                            
                            <form id="scrapForm" method="POST" action="/trcf_fnb_inventory/scrap_add">
                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                
                                <header class="mb-6">
                                    <p class="text-text-light-primary dark:text-text-dark-primary text-4xl font-black leading-tight tracking-[-0.033em] mb-2">Hủy Sản Phẩm</p>
                                    <p class="text-text-light-secondary dark:text-text-dark-secondary text-sm">Ghi nhận hàng hóa hư hỏng, hết hạn hoặc hao hụt</p>
                                </header>
                                
                                <div class="bg-white dark:bg-slate-900 border border-border-light dark:border-border-dark rounded-xl p-6">
                                    <div class="flex flex-col gap-6">
                                        
                                        <!-- Product Selection -->
                                        <div>
                                            <label class="flex flex-col w-full">
                                                <p class="text-text-light-secondary dark:text-text-dark-secondary text-sm font-medium leading-normal pb-2">
                                                    Chọn sản phẩm <span class="text-red-500">*</span>
                                                </p>
                                                <select id="product_select" name="product_id" required="required" onchange="updateUOM()" class="form-select flex w-full min-w-0 flex-1 overflow-hidden rounded-lg text-text-light-primary dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-border-light dark:border-border-dark bg-white dark:bg-slate-900 focus:border-primary dark:focus:border-primary h-12 px-3.5 text-sm font-normal leading-normal">
                                                    <option value="">-- Chọn sản phẩm --</option>
                                                    <t t-foreach="products" t-as="product">
                                                        <option t-att-value="product['id']" 
                                                                t-att-data-uom="product['uom_name']"
                                                                t-att-data-qty="product['qty_available']">
                                                            <t t-esc="product['name']"/> (<t t-esc="product['qty_available']"/> <t t-esc="product['uom_name']"/> có sẵn)
                                                        </option>
                                                    </t>
                                                </select>
                                            </label>
                                        </div>
                                        
                                        <!-- Quantity and UOM -->
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                                            <div class="md:col-span-2">
                                                <label class="flex flex-col w-full">
                                                    <p class="text-text-light-secondary dark:text-text-dark-secondary text-sm font-medium leading-normal pb-2">
                                                        Số lượng hủy <span class="text-red-500">*</span>
                                                    </p>
                                                    <input type="number" name="scrap_qty" id="scrap_qty" required="required" min="0.01" step="0.01" placeholder="Nhập số lượng..." class="form-input flex w-full min-w-0 flex-1 overflow-hidden rounded-lg text-text-light-primary dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-border-light dark:border-border-dark bg-white dark:bg-slate-900 focus:border-primary dark:focus:border-primary h-12 px-3.5 text-sm font-normal leading-normal placeholder:text-text-light-secondary dark:placeholder:text-text-dark-secondary"/>
                                                </label>
                                            </div>
                                            <div>
                                                <label class="flex flex-col w-full">
                                                    <p class="text-text-light-secondary dark:text-text-dark-secondary text-sm font-medium leading-normal pb-2">
                                                        Đơn vị
                                                    </p>
                                                    <input type="text" id="uom_display" readonly="readonly" placeholder="--" class="form-input flex w-full min-w-0 flex-1 overflow-hidden rounded-lg text-text-light-primary dark:text-white border border-border-light dark:border-border-dark bg-slate-100 dark:bg-slate-800 h-12 px-3.5 text-sm font-normal leading-normal opacity-60"/>
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <!-- Reason -->
                                        <div>
                                            <label class="flex flex-col w-full">
                                                <p class="text-text-light-secondary dark:text-text-dark-secondary text-sm font-medium leading-normal pb-2">
                                                    Lý do hủy hàng <span class="text-red-500">*</span>
                                                </p>
                                                <select name="reason" id="reason_select" required="required" onchange="toggleOtherReason()" class="form-select flex w-full min-w-0 flex-1 overflow-hidden rounded-lg text-text-light-primary dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-border-light dark:border-border-dark bg-white dark:bg-slate-900 focus:border-primary dark:focus:border-primary h-12 px-3.5 text-sm font-normal leading-normal">
                                                    <option value="">-- Chọn lý do --</option>
                                                    <t t-if="reasons">
                                                        <t t-foreach="reasons" t-as="reason">
                                                            <option t-att-value="reason['name']">
                                                                <t t-esc="reason['name']"/>
                                                            </option>
                                                        </t>
                                                    </t>
                                                    <t t-else="">
                                                        <!-- Fallback if no reasons defined in Odoo -->
                                                        <option value="Hết hạn sử dụng">Hết hạn sử dụng</option>
                                                        <option value="Sản phẩm hỏng/hư">Sản phẩm hỏng/hư</option>
                                                        <option value="Bể vỡ">Bể vỡ</option>
                                                        <option value="Chất lượng không đạt">Chất lượng không đạt</option>
                                                        <option value="Mốc/ẩm">Mốc/ẩm</option>
                                                        <option value="Đổ/rơi vãi">Đổ/rơi vãi</option>
                                                    </t>
                                                    <option value="Khác">Khác (nhập chi tiết)</option>
                                                </select>
                                            </label>
                                        </div>
                                        
                                        <!-- Other Reason Input (hidden by default) -->
                                        <div id="other_reason_container" style="display: none;">
                                            <label class="flex flex-col w-full">
                                                <p class="text-text-light-secondary dark:text-text-dark-secondary text-sm font-medium leading-normal pb-2">
                                                    Chi tiết lý do khác
                                                </p>
                                                <textarea name="other_reason" id="other_reason" rows="3" placeholder="Nhập chi tiết lý do..." class="form-textarea w-full min-w-0 flex-1 resize-y overflow-hidden rounded-lg text-text-light-primary dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-border-light dark:border-border-dark bg-white dark:bg-slate-900 focus:border-primary dark:focus:border-primary px-3.5 py-3 text-sm font-normal leading-normal placeholder:text-text-light-secondary dark:placeholder:text-text-dark-secondary"></textarea>
                                            </label>
                                        </div>
                                        
                                        <!-- Submit Button -->
                                        <div class="pt-2">
                                            <button type="submit" class="flex w-full items-center justify-center gap-x-2 h-12 px-4 rounded-lg bg-red-600 hover:bg-red-700 dark:bg-red-600 dark:hover:bg-red-700 text-white transition-colors text-sm font-bold">
                                                <span class="material-symbols-outlined text-base">delete_forever</span>
                                                <span>Xác Nhận Hủy</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </main>
                </div>
                
                <!-- JavaScript -->
                <script>
                <![CDATA[
                    function updateUOM() {
                        const select = document.getElementById('product_select');
                        const selectedOption = select.options[select.selectedIndex];
                        const uomDisplay = document.getElementById('uom_display');
                        
                        if (selectedOption.value) {
                            const uom = selectedOption.getAttribute('data-uom');
                            uomDisplay.value = uom;
                        } else {
                            uomDisplay.value = '';
                        }
                    }
                    
                    function toggleOtherReason() {
                        const reasonSelect = document.getElementById('reason_select');
                        const otherContainer = document.getElementById('other_reason_container');
                        const otherTextarea = document.getElementById('other_reason');
                        
                        if (reasonSelect.value === 'Khác') {
                            otherContainer.style.display = 'block';
                            otherTextarea.required = true;
                        } else {
                            otherContainer.style.display = 'none';
                            otherTextarea.required = false;
                            otherTextarea.value = '';
                        }
                    }
                    
                    // Form validation
                    document.getElementById('scrapForm').addEventListener('submit', function(e) {
                        const productId = document.getElementById('product_select').value;
                        const qty = parseFloat(document.getElementById('scrap_qty').value);
                        const reason = document.getElementById('reason_select').value;
                        
                        if (!productId) {
                            e.preventDefault();
                            alert('Vui lòng chọn sản phẩm');
                            return false;
                        }
                        
                        if (!qty || qty <= 0) {
                            e.preventDefault();
                            alert('Số lượng hủy phải lớn hơn 0');
                            return false;
                        }
                        
                        if (!reason) {
                            e.preventDefault();
                            alert('Vui lòng chọn lý do hủy hàng');
                            return false;
                        }
                        
                        if (reason === 'Khác') {
                            const otherReason = document.getElementById('other_reason').value.trim();
                            if (!otherReason) {
                                e.preventDefault();
                                alert('Vui lòng nhập chi tiết lý do khác');
                                return false;
                            }
                        }
                        
                        return true;
                    });
                ]]>
                </script>
            </body>
            
        </xpath>

    </template>
</odoo>